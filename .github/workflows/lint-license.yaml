name: Lint Licnese checks

# Any change in triggers needs to be reflected in the concurrency group.
on:
  pull_request: {}
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      ref:
        description: 'sha, tag, branch'
        required: true
        default: main

permissions: read-all

# for each pr, queue all workflows
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.event.after }}
  cancel-in-progress: true

jobs:
  go-mod:
    runs-on: ubuntu-latest
    steps:
      - name: Checking Ref
        id: version
        shell: bash
        run: |
          if ${{ github.event_name == 'workflow_dispatch' }}; then
            tag_name=${{ github.event.inputs.ref }}
            echo ::set-output name=ref::${tag_name}
          else
            echo ::set-output name=ref::${GITHUB_REF##*/}
          fi

      - name: Checkout Source Code
        uses: actions/checkout@v3
        with:
          persist-credentials: false
          ref: ${{ steps.version.outputs.ref }}

      # https://github.com/marketplace/actions/license-eye
      - name: Check License Header
        uses: apache/skywalking-eyes@v0.2.0
        with:
          mode: fix

      - name: Apply Changes
        uses: EndBug/add-and-commit@v4
        with:
          author_name: License Bot
          author_email: license_bot@github.com
          message: 'Automatic application of license header'
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
